<!DOCTYPE html>
<html>
<head>
    <title>CORS Test - Browser Perspective</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>CORS Test - Browser Perspective</h1>
    <p>This tests CORS from the browser's perspective, exactly as the extension would.</p>
    
    <div id="results"></div>
    
    <script>
        const API_URL = 'https://rvised-pj1pqwanw-tysonso1122-2100s-projects.vercel.app';
        const results = document.getElementById('results');
        
        function logTest(name, success, details) {
            const div = document.createElement('div');
            div.className = `test ${success ? 'success' : 'error'}`;
            div.innerHTML = `
                <h3>${name}: ${success ? '‚úÖ SUCCESS' : '‚ùå FAILED'}</h3>
                <pre>${JSON.stringify(details, null, 2)}</pre>
            `;
            results.appendChild(div);
        }
        
        // Test 1: Simple GET request (no preflight)
        fetch(`${API_URL}/api/health`)
            .then(r => {
                const corsHeader = r.headers.get('access-control-allow-origin');
                logTest('GET /api/health', true, {
                    status: r.status,
                    cors_header: corsHeader,
                    has_cors: !!corsHeader
                });
                return r.json();
            })
            .then(data => console.log('Health data:', data))
            .catch(e => logTest('GET /api/health', false, { error: e.message }));
        
        // Test 2: POST with JSON (triggers preflight)
        fetch(`${API_URL}/api/summarize`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                videoUrl: 'https://www.youtube.com/watch?v=test',
                extensionTranscript: 'Test transcript'
            })
        })
        .then(r => {
            const corsHeader = r.headers.get('access-control-allow-origin');
            logTest('POST /api/summarize with JSON', !!corsHeader, {
                status: r.status,
                cors_header: corsHeader,
                has_cors: !!corsHeader,
                readable_headers: Array.from(r.headers.entries())
            });
            return r.json();
        })
        .then(data => console.log('Summarize response:', data))
        .catch(e => logTest('POST /api/summarize with JSON', false, { 
            error: e.message,
            type: e.constructor.name,
            stack: e.stack?.split('\n').slice(0, 3).join('\n')
        }));
        
        // Test 3: Simulate Chrome Extension origin
        fetch(`${API_URL}/api/summarize`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Origin': 'chrome-extension://abcdefghijklmnop'
            },
            body: JSON.stringify({
                videoUrl: 'https://www.youtube.com/watch?v=test',
                extensionTranscript: 'Test from extension'
            })
        })
        .then(r => {
            const corsHeader = r.headers.get('access-control-allow-origin');
            logTest('POST with extension origin', !!corsHeader, {
                status: r.status,
                cors_header: corsHeader,
                all_headers: Object.fromEntries(r.headers.entries())
            });
            return r.json();
        })
        .then(data => console.log('Extension response:', data))
        .catch(e => logTest('POST with extension origin', false, { error: e.message }));
        
        // Test 4: Check if browser sees CORS headers in network tab
        setTimeout(() => {
            const msg = document.createElement('div');
            msg.className = 'test';
            msg.innerHTML = `
                <h3>üìã Manual Check Instructions:</h3>
                <ol>
                    <li>Open DevTools (F12)</li>
                    <li>Go to Network tab</li>
                    <li>Look for the requests above</li>
                    <li>Click on a request and check Response Headers</li>
                    <li>You should see Access-Control-Allow-Origin: *</li>
                </ol>
                <p><strong>If you see CORS errors in console but headers are present in Network tab, 
                   it might be a browser caching issue. Try:</strong></p>
                <ul>
                    <li>Hard refresh (Ctrl+Shift+R)</li>
                    <li>Open in Incognito mode</li>
                    <li>Clear browser cache</li>
                </ul>
            `;
            results.appendChild(msg);
        }, 2000);
    </script>
</body>
</html>